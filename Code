import os
from datetime import datetime

FILE_USER = "users.txt"

def load_users():
    users = {}
    if not os.path.exists(FILE_USER):
        open(FILE_USER, "w").close()
    with open(FILE_USER, "r") as f:
        for line in f:
            parts = line.strip().split("|")
            if len(parts) == 4:
                id_user, username, pin, saldo = parts
                users[username] = [id_user, pin, int(saldo)]
    return users

def save_users(users):
    with open(FILE_USER, "w") as f:
        for username, data in users.items():
            id_user, pin, saldo = data
            f.write(f"{id_user}|{username}|{pin}|{saldo}\n")

def id(users, id_target):
    for username, data in users.items():
        if data[0] == id_target:
            return username
    return None

def auth_pin(users, username):
    pin_input = input("Masukkan PIN kembali: ")
    return pin_input == users[username][1]

def catat_riwayat(username, aksi, jumlah=None, saldo=None):
    waktu = datetime.now().strftime("[%Y-%m-%d %H:%M:%S]")
    with open(f"riwayat_{username}.txt", "a") as f:
        if aksi == "setor":
            f.write(f"{waktu} SETOR: +{jumlah}\n")
        elif aksi == "tarik":
            f.write(f"{waktu} TARIK: -{jumlah}\n")
        elif aksi == "saldo":
            f.write(f"{waktu} CEK SALDO: Rp{saldo}\n")
        elif aksi == "login":
            f.write(f"{waktu} LOGIN BERHASIL\n")

def tampilkan_menu():
    print("\n=== MENU ATM ===")
    print("1. Cek Saldo")
    print("2. Tarik Tunai")
    print("3. Setor Tunai")
    print("4. Lihat Riwayat Transaksi")
    print("5. Logout")

def login(users):
    print("\n=== LOGIN ===")
    for percobaan in range(3):
        username = input("Masukkan username: ")
        pin = input("Masukkan PIN: ")
        if username in users and users[username][0] == pin:
            print(f"\nLogin berhasil. Selamat datang, {username}!")
            catat_riwayat(username, "login")
            return username
        else:
            sisa = 2 - percobaan
            print(f"Login gagal. Username atau PIN salah. Sisa percobaan: {sisa}")
    print("Anda telah 3 kali gagal login. Kembali ke menu utama.\n")
    return None


def tambah_user(users):
    print("\n=== TAMBAH USER BARU ===")
    username = input("Masukkan username baru: ")
    if "|" in username:
        print("Username tidak boleh mengandung karakter '|'.")
        return
    if username in users:
        print("Username sudah digunakan.")
        return
    pin = input("Masukkan PIN baru (6 digit): ")
    if not pin.isdigit() or len(pin) != 6:
        print("PIN harus 6 digit angka.")
        return
    existing_ids = [int(data["id"]) for data in users.values()]
    next_id = max(existing_ids) + 1 if existing_ids else 1001
    users[username] = {"id": str(next_id), "pin": pin, "saldo": 0}
    save_users(users)
    print(f"User {username} berhasil ditambahkan dengan ID {next_id}.")

def atm(username, users):
    while True:
        tampilkan_menu()
        pilihan = input("Pilih menu (1-5): ")

        if pilihan == "1":
            saldo = users[username][1]
            print(f"Saldo Anda: Rp{saldo:,}")
            catat_riwayat(username, "saldo", saldo=saldo)

        elif pilihan == "2":
            if not auth_pin(users, username):
                print("PIN salah.")
                continue
                
            while True:
                print("\nNominal Tarik Tunai:")
                print("1. Rp100.000")
                print("2. Rp300.000")
                print("3. Rp500.000")
                print("4. Rp1.000.000")
                print("5. Custom (Minimal Rp50.000)")
    
                pilihan_tarik = input("Pilih opsi (1-5): ")
                nominal_map = {"1": 100_000, "2": 300_000, "3": 500_000, "4": 1_000_000}
    
                if pilihan_tarik in nominal_map:
                    jumlah = nominal_map[pilihan_tarik]
                elif pilihan_tarik == "5":
                    try:
                        jumlah = int(input("Masukkan jumlah tarik tunai: Rp"))
                        if jumlah < 50000:
                            print("Minimal penarikan Rp50.000")
                            continue
                    except ValueError:
                        print("Input tidak valid.")
                    
                else:
                    print("Pilihan tidak valid.")
                    continue
        
                if jumlah > users[username][1]:
                    print("Saldo tidak cukup.")
                    break
                else:
                    users[username][1] -= jumlah
                    print(f"Penarikan berhasil. Sisa saldo: Rp{users[username][1]:,}")
                    catat_riwayat(username, "tarik", jumlah=jumlah)
                    break

        elif pilihan == "3":
            if not auth_pin(users, username):
                print("PIN salah.")
                continue

            while True:
                id_tujuan = input("Masukkan ID pengguna tujuan: ")
                username_tujuan = id(users, id_tujuan)
                if username_tujuan is None:
                    print("ID tidak ditemukan. Silakan coba lagi.")
                    continue
                if username_tujuan == username:
                    print("Tidak bisa setor ke akun sendiri.")
                    continue
                break
                
            while True:
                try:
                    nominal = int(input("Masukkan jumlah setoran: "))
                    if nominal % 50000 != 0:
                        print("Jumlah setoran harus kelipatan Rp.50.000")
                        continue
                    users[username_tujuan][1] += nominal
                    save_users(users)
                    print(f"Setoran berhasil. Saldo sekarang: Rp{users[username][1]:,}")
                    catat_riwayat(username, "setor", jumlah=nominal)
                    break                
                except ValueError:
                    print("Input tidak valid. Masukkan angka.")

        elif pilihan == "4":
            print(f"\n=== RIWAYAT TRANSAKSI ({username}) ===")
            try:
                with open(f"riwayat_{username}.txt", "r") as f:
                    print(f.read())                   
            except FileNotFoundError:
                print("Belum ada riwayat transaksi.")

        elif pilihan == "5":
            print("Logout dari sesi ATM.")
            break

        else:
            print("Pilihan tidak valid.")

def main():
    users = load_users()
    while True:
        print("\n=== SELAMAT DATANG DI ATM SKIBIDI ===")
        print("1. Login")
        print("2. Tambah User Baru")
        print("3. Keluar")
        menu = input("Pilih menu (1-3): ")

        if menu == "1":
            user = login(users)
            if user:
                atm(user, users)
        elif menu == "2":
            tambah_user(users)
        elif menu == "3":
            print("Terima kasih telah menggunakan ATM SKIBIDI.")
            break
        else:
            print("Pilihan tidak valid.")

if __name__ == "__main__":
    main()
